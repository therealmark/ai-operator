<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>AI Operator â€” Customers</title>
  <style>
    *, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }

    :root {
      --bg:      #0f172a;
      --surface: #1e293b;
      --border:  #334155;
      --text:    #e2e8f0;
      --muted:   #94a3b8;
      --dim:     #64748b;
      --accent:  #ec4899;
      --accent2: #a855f7;
      --green:   #4ade80;
      --red:     #f87171;
      --blue:    #7dd3fc;
      --radius:  10px;
    }

    body {
      background: var(--bg);
      color: var(--text);
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
      font-size: 14px;
      min-height: 100vh;
    }

    /* â”€â”€ Layout â”€â”€ */
    #loader {
      position: fixed; inset: 0;
      background: var(--bg);
      display: flex; flex-direction: column;
      align-items: center; justify-content: center;
      gap: 12px; z-index: 100;
    }
    #loader-spinner {
      width: 32px; height: 32px;
      border: 3px solid var(--border);
      border-top-color: var(--accent);
      border-radius: 50%;
      animation: spin .7s linear infinite;
    }
    @keyframes spin { to { transform: rotate(360deg); } }
    #loader-text { color: var(--dim); font-size: 15px; }

    #app { display: none; max-width: 1280px; margin: 0 auto; padding: 32px 24px 64px; }

    /* â”€â”€ Cards & containers â”€â”€ */
    .card {
      background: var(--surface);
      border: 1px solid var(--border);
      border-radius: var(--radius);
      padding: 20px;
    }

    /* â”€â”€ Header â”€â”€ */
    .header {
      display: flex; align-items: center;
      justify-content: space-between;
      flex-wrap: wrap; gap: 12px;
      margin-bottom: 28px;
    }
    .header-left { display: flex; align-items: center; gap: 10px; }
    .logo {
      width: 34px; height: 34px;
      border-radius: 8px;
      background: linear-gradient(135deg, #ec4899, #a855f7);
      display: flex; align-items: center; justify-content: center;
      flex-shrink: 0;
    }
    h1 { font-size: 18px; font-weight: 700; }
    .header-right { display: flex; align-items: center; gap: 8px; flex-wrap: wrap; }
    #last-updated { font-size: 11px; color: var(--dim); }

    /* â”€â”€ Buttons â”€â”€ */
    .btn {
      display: inline-flex; align-items: center; gap: 6px;
      background: var(--surface); border: 1px solid var(--border);
      color: var(--muted); border-radius: 8px;
      padding: 7px 14px; font-size: 13px;
      cursor: pointer; transition: border-color .15s, color .15s;
      font-family: inherit;
    }
    .btn:hover { border-color: var(--accent); color: var(--accent); }
    .btn-primary {
      background: linear-gradient(135deg, #ec4899, #a855f7);
      border-color: transparent; color: white;
    }
    .btn-primary:hover { opacity: .9; border-color: transparent; color: white; }
    .btn-danger { border-color: var(--red); color: var(--red); }
    .btn-danger:hover { background: rgba(248,113,113,.1); }
    .btn-sm { padding: 4px 10px; font-size: 12px; }
    .btn-icon { padding: 6px; }

    /* â”€â”€ Summary cards â”€â”€ */
    #summary-cards {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(160px, 1fr));
      gap: 16px;
      margin-bottom: 24px;
    }
    .stat-card { padding: 18px 20px; }
    .stat-num { font-size: 2rem; font-weight: 800; line-height: 1; color: white; }
    .stat-label { font-size: 12px; color: var(--muted); margin-top: 4px; }
    .stat-sub { font-size: 11px; color: var(--dim); margin-top: 2px; }

    /* â”€â”€ Toolbar â”€â”€ */
    .toolbar {
      display: flex; align-items: center; gap: 10px;
      flex-wrap: wrap; margin-bottom: 16px;
    }
    .search-wrap { position: relative; flex: 1; min-width: 220px; }
    .search-wrap svg { position: absolute; left: 10px; top: 50%; transform: translateY(-50%); color: var(--dim); }
    #search {
      width: 100%;
      background: var(--bg); border: 1px solid var(--border);
      color: var(--text); border-radius: 8px;
      padding: 8px 12px 8px 34px;
      font-size: 13px; outline: none; font-family: inherit;
      transition: border-color .15s;
    }
    #search:focus { border-color: var(--accent); }
    #row-count { font-size: 12px; color: var(--dim); white-space: nowrap; }

    /* â”€â”€ Table â”€â”€ */
    .table-wrap { overflow-x: auto; }
    table { width: 100%; border-collapse: collapse; font-size: 13px; }
    thead tr { border-bottom: 1px solid var(--border); }
    th {
      text-align: left; padding: 0 16px 10px 0;
      font-size: 11px; font-weight: 600; color: var(--dim);
      text-transform: uppercase; letter-spacing: .04em;
      cursor: pointer; user-select: none; white-space: nowrap;
    }
    th:hover { color: var(--text); }
    th.sort-asc::after  { content: ' â†‘'; color: var(--accent); }
    th.sort-desc::after { content: ' â†“'; color: var(--accent); }
    th:last-child { text-align: right; }
    tbody tr { border-bottom: 1px solid rgba(51,65,85,.5); transition: background .1s; }
    tbody tr:hover { background: rgba(255,255,255,.03); }
    td { padding: 12px 16px 12px 0; vertical-align: middle; }
    td:last-child { text-align: right; }
    .td-name { font-weight: 600; color: var(--text); }
    .td-email { font-family: monospace; font-size: 12px; color: #7dd3fc; }
    .td-muted { color: var(--muted); }
    .td-dim { color: var(--dim); font-size: 12px; }

    /* â”€â”€ Tags â”€â”€ */
    .tag {
      display: inline-block;
      background: rgba(125, 211, 252, .12);
      color: var(--blue);
      font-size: 10px; font-weight: 600;
      padding: 2px 7px; border-radius: 6px;
      margin: 1px; white-space: nowrap;
    }
    .tag-empty { color: var(--dim); font-style: italic; }

    /* â”€â”€ Modal â”€â”€ */
    .modal-backdrop {
      display: none;
      position: fixed; inset: 0;
      background: rgba(0,0,0,.65);
      z-index: 200;
      align-items: center; justify-content: center;
      padding: 16px;
    }
    .modal-backdrop.open { display: flex; }
    .modal {
      background: var(--surface);
      border: 1px solid var(--border);
      border-radius: 14px;
      padding: 28px;
      width: 100%; max-width: 520px;
      max-height: 90vh; overflow-y: auto;
    }
    .modal-title {
      font-size: 17px; font-weight: 700;
      margin-bottom: 20px;
    }
    .form-grid { display: flex; flex-direction: column; gap: 14px; }
    label { display: block; font-size: 12px; color: var(--muted); margin-bottom: 5px; }
    input[type=text], input[type=email], textarea, select {
      width: 100%;
      background: var(--bg); border: 1px solid var(--border);
      color: var(--text); border-radius: 8px;
      padding: 9px 12px; font-size: 13px;
      outline: none; font-family: inherit;
      transition: border-color .15s;
    }
    input[type=text]:focus, input[type=email]:focus,
    textarea:focus, select:focus { border-color: var(--accent); }
    textarea { resize: vertical; min-height: 80px; }
    .modal-footer {
      display: flex; justify-content: flex-end;
      gap: 8px; margin-top: 24px;
    }
    .form-error { font-size: 12px; color: var(--red); margin-top: 4px; }

    /* â”€â”€ Toast â”€â”€ */
    #toast {
      position: fixed; bottom: 24px; right: 24px;
      background: var(--surface); border: 1px solid var(--border);
      border-radius: 10px; padding: 12px 18px;
      font-size: 13px; color: var(--text);
      display: none; z-index: 300;
      box-shadow: 0 8px 32px rgba(0,0,0,.4);
      max-width: 320px;
    }
    #toast.success { border-color: var(--green); color: var(--green); }
    #toast.error   { border-color: var(--red);   color: var(--red);   }

    /* â”€â”€ Empty state â”€â”€ */
    .empty {
      padding: 48px 0; text-align: center; color: var(--dim);
    }
    .empty-icon { font-size: 36px; margin-bottom: 8px; }
    .empty-title { font-size: 15px; font-weight: 600; color: var(--muted); }
    .empty-sub { font-size: 13px; margin-top: 4px; }

    /* â”€â”€ Detail sidebar â”€â”€ */
    .detail-panel {
      display: none;
      position: fixed; top: 0; right: 0; bottom: 0;
      width: 360px; background: var(--surface);
      border-left: 1px solid var(--border);
      z-index: 150; overflow-y: auto;
      padding: 24px;
    }
    .detail-panel.open { display: block; }
    .detail-header {
      display: flex; align-items: center;
      justify-content: space-between; margin-bottom: 20px;
    }
    .detail-name { font-size: 16px; font-weight: 700; }
    .detail-section { margin-top: 20px; }
    .detail-section-title {
      font-size: 11px; font-weight: 600; color: var(--dim);
      text-transform: uppercase; letter-spacing: .05em;
      margin-bottom: 10px;
    }
    .detail-row {
      display: flex; flex-direction: column;
      gap: 3px; margin-bottom: 12px;
    }
    .detail-key { font-size: 11px; color: var(--dim); }
    .detail-val { font-size: 13px; color: var(--text); word-break: break-all; }
    .detail-actions { display: flex; gap: 8px; flex-wrap: wrap; margin-top: 20px; }
  </style>
</head>
<body>

<!-- Loader -->
<div id="loader">
  <div id="loader-spinner"></div>
  <div id="loader-text">Loading customersâ€¦</div>
</div>

<!-- Main app -->
<div id="app">

  <!-- Header -->
  <div class="header">
    <div class="header-left">
      <div class="logo">
        <svg width="16" height="16" fill="none" stroke="white" stroke-width="2.5" viewBox="0 0 24 24">
          <circle cx="9" cy="7" r="4"/>
          <path d="M3 21v-2a4 4 0 0 1 4-4h4a4 4 0 0 1 4 4v2"/>
          <path d="M16 3.13a4 4 0 0 1 0 7.75"/>
          <path d="M21 21v-2a4 4 0 0 0-3-3.87"/>
        </svg>
      </div>
      <h1>AI Operator â€” Customers</h1>
    </div>
    <div class="header-right">
      <span id="last-updated"></span>
      <button class="btn btn-sm" onclick="load()">
        <svg width="13" height="13" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><polyline points="23 4 23 10 17 10"/><path d="M20.49 15a9 9 0 1 1-2.12-9.36L23 10"/></svg>
        Refresh
      </button>
      <button class="btn btn-sm" onclick="exportCSV()">
        <svg width="13" height="13" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="7 10 12 15 17 10"/><line x1="12" y1="15" x2="12" y2="3"/></svg>
        Export CSV
      </button>
      <button class="btn btn-sm btn-primary" onclick="openAddModal()">
        <svg width="13" height="13" fill="none" stroke="currentColor" stroke-width="2.5" viewBox="0 0 24 24"><line x1="12" y1="5" x2="12" y2="19"/><line x1="5" y1="12" x2="19" y2="12"/></svg>
        Add Customer
      </button>
    </div>
  </div>

  <!-- Summary cards -->
  <div id="summary-cards"></div>

  <!-- Table card -->
  <div class="card">
    <div class="toolbar">
      <div class="search-wrap">
        <svg width="14" height="14" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><circle cx="11" cy="11" r="8"/><line x1="21" y1="21" x2="16.65" y2="16.65"/></svg>
        <input type="text" id="search" placeholder="Search by name, email, or businessâ€¦" oninput="renderTable()" />
      </div>
      <span id="row-count"></span>
    </div>
    <div class="table-wrap">
      <table>
        <thead>
          <tr>
            <th id="th-name"            onclick="sortBy('name')">Name</th>
            <th id="th-email"           onclick="sortBy('email')">Email</th>
            <th id="th-businessName"    onclick="sortBy('businessName')">Business</th>
            <th>Products</th>
            <th id="th-purchaseCount"   onclick="sortBy('purchaseCount')">Purchases</th>
            <th id="th-firstPurchaseAt" onclick="sortBy('firstPurchaseAt')">First</th>
            <th id="th-lastPurchaseAt"  onclick="sortBy('lastPurchaseAt')">Last</th>
            <th>Actions</th>
          </tr>
        </thead>
        <tbody id="customer-rows"></tbody>
      </table>
    </div>
  </div>
</div>

<!-- Add / Edit Modal -->
<div class="modal-backdrop" id="modal-backdrop" onclick="closeModal(event)">
  <div class="modal" onclick="event.stopPropagation()">
    <div class="modal-title" id="modal-title">Add Customer</div>
    <div class="form-grid">
      <div>
        <label>Email *</label>
        <input type="email" id="f-email" placeholder="customer@example.com" />
        <div class="form-error" id="err-email"></div>
      </div>
      <div>
        <label>Full Name</label>
        <input type="text" id="f-name" placeholder="Jane Smith" />
      </div>
      <div>
        <label>Business Name</label>
        <input type="text" id="f-business" placeholder="Acme Corp" />
      </div>
      <div>
        <label>Notes</label>
        <textarea id="f-notes" placeholder="Internal notes about this customerâ€¦"></textarea>
      </div>
    </div>
    <div class="modal-footer">
      <button class="btn" onclick="closeModal()">Cancel</button>
      <button class="btn btn-primary" id="modal-save-btn" onclick="saveCustomer()">Save</button>
    </div>
  </div>
</div>

<!-- Detail Panel -->
<div class="detail-panel" id="detail-panel">
  <div class="detail-header">
    <div class="detail-name" id="dp-name">â€”</div>
    <button class="btn btn-icon" onclick="closeDetail()" title="Close">
      <svg width="16" height="16" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><line x1="18" y1="6" x2="6" y2="18"/><line x1="6" y1="6" x2="18" y2="18"/></svg>
    </button>
  </div>

  <div class="detail-section">
    <div class="detail-section-title">Contact</div>
    <div class="detail-row"><div class="detail-key">Email</div><div class="detail-val" id="dp-email">â€”</div></div>
    <div class="detail-row"><div class="detail-key">Business</div><div class="detail-val" id="dp-business">â€”</div></div>
    <div class="detail-row"><div class="detail-key">Stripe ID</div><div class="detail-val" id="dp-stripe">â€”</div></div>
  </div>

  <div class="detail-section">
    <div class="detail-section-title">Purchases</div>
    <div class="detail-row"><div class="detail-key">Total Purchases</div><div class="detail-val" id="dp-count">â€”</div></div>
    <div class="detail-row"><div class="detail-key">Products</div><div class="detail-val" id="dp-products">â€”</div></div>
    <div class="detail-row"><div class="detail-key">First Purchase</div><div class="detail-val" id="dp-first">â€”</div></div>
    <div class="detail-row"><div class="detail-key">Last Purchase</div><div class="detail-val" id="dp-last">â€”</div></div>
  </div>

  <div class="detail-section">
    <div class="detail-section-title">Notes</div>
    <div class="detail-val" id="dp-notes" style="color:var(--muted); white-space:pre-wrap; font-size:13px;">â€”</div>
  </div>

  <div class="detail-actions">
    <button class="btn btn-sm" id="dp-edit-btn" onclick="editCurrentDetail()">
      <svg width="12" height="12" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"/><path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"/></svg>
      Edit
    </button>
    <button class="btn btn-sm btn-danger" id="dp-delete-btn" onclick="deleteCurrentDetail()">
      <svg width="12" height="12" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><polyline points="3 6 5 6 21 6"/><path d="M19 6l-1 14a2 2 0 0 1-2 2H8a2 2 0 0 1-2-2L5 6"/><path d="M10 11v6"/><path d="M14 11v6"/></svg>
      Delete
    </button>
  </div>
</div>

<!-- Toast -->
<div id="toast"></div>

<script>
const API = 'https://z01mzuzo05.execute-api.us-east-1.amazonaws.com/prod/api/customers';
const KEY = '2c9a66158ebeb785fea45ccc47af61d1fa6f02be9f380a4d';

let allCustomers = [];
let sortField    = 'lastPurchaseAt';
let sortDir      = 'desc';
let editEmail    = null; // null = add mode, string = edit mode
let detailEmail  = null;

// â”€â”€ Helpers â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

function $(id) { return document.getElementById(id); }

function fmt(iso) {
  if (!iso) return 'â€”';
  try {
    return new Date(iso).toLocaleDateString('en-US', { month:'short', day:'numeric', year:'numeric' });
  } catch { return iso; }
}

function fmtProduct(p) {
  return (p || '').replace(/\.zip$|\.pdf$/i,'').replace(/-/g,' ')
    .replace(/\b\w/g, c => c.toUpperCase());
}

function esc(s) {
  return String(s || '').replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/"/g,'&quot;');
}

let toastTimer;
function toast(msg, type = 'success') {
  const el = $('toast');
  el.textContent = msg;
  el.className   = type;
  el.style.display = 'block';
  clearTimeout(toastTimer);
  toastTimer = setTimeout(() => { el.style.display = 'none'; }, 3500);
}

// â”€â”€ Load â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

async function load() {
  $('loader-text').textContent = 'Loading customersâ€¦';
  $('loader').style.display = 'flex';
  $('app').style.display    = 'none';

  try {
    const res = await fetch(API, {
      headers: { 'x-metrics-key': KEY },
    });

    if (res.status === 401) {
      $('loader-text').textContent = 'Access denied â€” check API key.';
      return;
    }
    if (!res.ok) {
      $('loader-text').textContent = `API error: ${res.status}`;
      return;
    }

    const data = await res.json();
    allCustomers = Array.isArray(data.customers) ? data.customers : [];

    renderSummary(data.summary || {});
    renderTable();

    $('loader').style.display = 'none';
    $('app').style.display    = 'block';
    $('last-updated').textContent = 'Updated ' + new Date().toLocaleTimeString();

  } catch (e) {
    $('loader-text').textContent = 'Failed to connect: ' + e.message;
    console.error('[customers] load failed', e);
  }
}

// â”€â”€ Summary â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

function renderSummary(s) {
  const topProduct = (s.topProducts || [])[0];
  const cards = [
    { label: 'Total Customers', value: s.totalCustomers ?? 0,  sub: 'unique buyers' },
    { label: 'Total Purchases', value: s.totalPurchases ?? 0,  sub: 'across all customers' },
    { label: 'Top Product',     value: topProduct ? topProduct.count : 'â€”',
                                sub: topProduct ? fmtProduct(topProduct.name) : 'none yet' },
    { label: 'Avg Purchases',   value: s.totalCustomers
        ? (s.totalPurchases / s.totalCustomers).toFixed(1) : '0',
      sub: 'per customer' },
  ];
  $('summary-cards').innerHTML = cards.map(c => `
    <div class="card stat-card">
      <div class="stat-num">${esc(String(c.value))}</div>
      <div class="stat-label">${esc(c.label)}</div>
      <div class="stat-sub">${esc(c.sub)}</div>
    </div>`).join('');
}

// â”€â”€ Table â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

function sortBy(field) {
  if (sortField === field) {
    sortDir = sortDir === 'asc' ? 'desc' : 'asc';
  } else {
    sortField = field;
    sortDir   = field === 'purchaseCount' ? 'desc' : 'asc';
  }
  renderTable();
}

function renderTable() {
  const q    = ($('search').value || '').toLowerCase().trim();
  let rows   = allCustomers.filter(c =>
    !q ||
    (c.email||'').toLowerCase().includes(q) ||
    (c.name||'').toLowerCase().includes(q) ||
    (c.businessName||'').toLowerCase().includes(q) ||
    (c.notes||'').toLowerCase().includes(q)
  );

  rows.sort((a, b) => {
    let va = a[sortField] ?? '';
    let vb = b[sortField] ?? '';
    if (sortField === 'purchaseCount') {
      return sortDir === 'asc' ? Number(va) - Number(vb) : Number(vb) - Number(va);
    }
    return sortDir === 'asc'
      ? String(va).localeCompare(String(vb))
      : String(vb).localeCompare(String(va));
  });

  // Update sort headers
  ['name','email','businessName','purchaseCount','firstPurchaseAt','lastPurchaseAt'].forEach(f => {
    const th = $('th-' + f);
    if (!th) return;
    th.className = f === sortField ? 'sort-' + sortDir : '';
  });

  $('row-count').textContent = `${rows.length} customer${rows.length !== 1 ? 's' : ''}`;

  if (rows.length === 0) {
    $('customer-rows').innerHTML = `
      <tr><td colspan="8">
        <div class="empty">
          <div class="empty-icon">ğŸ‘¥</div>
          <div class="empty-title">No customers yet${q ? ' matching your search' : ''}</div>
          <div class="empty-sub">${q ? 'Try a different search term.' : 'Customers will appear here after a Stripe checkout.'}</div>
        </div>
      </td></tr>`;
    return;
  }

  $('customer-rows').innerHTML = rows.map(c => {
    const products = Array.isArray(c.products) && c.products.length
      ? c.products.map(p => `<span class="tag">${esc(fmtProduct(p))}</span>`).join('')
      : `<span class="tag-empty">â€”</span>`;
    return `
      <tr style="cursor:pointer" onclick="openDetail('${esc(c.email)}')">
        <td class="td-name">${esc(c.name || 'â€”')}</td>
        <td class="td-email">${esc(c.email)}</td>
        <td class="td-muted">${esc(c.businessName || 'â€”')}</td>
        <td>${products}</td>
        <td style="text-align:right; font-weight:700; color:white">${c.purchaseCount || 0}</td>
        <td class="td-dim">${fmt(c.firstPurchaseAt)}</td>
        <td class="td-dim">${fmt(c.lastPurchaseAt)}</td>
        <td onclick="event.stopPropagation()">
          <button class="btn btn-sm" onclick="openEditModal('${esc(c.email)}')" title="Edit">âœï¸</button>
          <button class="btn btn-sm" onclick="confirmDelete('${esc(c.email)}')" title="Delete" style="margin-left:4px">ğŸ—‘ï¸</button>
        </td>
      </tr>`;
  }).join('');
}

// â”€â”€ Add / Edit Modal â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

function openAddModal() {
  editEmail = null;
  $('modal-title').textContent  = 'Add Customer';
  $('modal-save-btn').textContent = 'Add Customer';
  $('f-email').value    = '';
  $('f-email').disabled = false;
  $('f-name').value     = '';
  $('f-business').value = '';
  $('f-notes').value    = '';
  $('err-email').textContent = '';
  $('modal-backdrop').classList.add('open');
  setTimeout(() => $('f-email').focus(), 50);
}

function openEditModal(email) {
  const c = allCustomers.find(x => x.email === email);
  if (!c) return;
  editEmail = email;
  $('modal-title').textContent  = 'Edit Customer';
  $('modal-save-btn').textContent = 'Save Changes';
  $('f-email').value    = c.email;
  $('f-email').disabled = true;
  $('f-name').value     = c.name        || '';
  $('f-business').value = c.businessName|| '';
  $('f-notes').value    = c.notes       || '';
  $('err-email').textContent = '';
  $('modal-backdrop').classList.add('open');
  setTimeout(() => $('f-name').focus(), 50);
}

function closeModal(e) {
  if (e && e.target !== $('modal-backdrop')) return;
  $('modal-backdrop').classList.remove('open');
}

async function saveCustomer() {
  const email    = $('f-email').value.trim().toLowerCase();
  const name     = $('f-name').value.trim();
  const business = $('f-business').value.trim();
  const notes    = $('f-notes').value.trim();

  $('err-email').textContent = '';

  if (!email) {
    $('err-email').textContent = 'Email is required.';
    $('f-email').focus();
    return;
  }
  if (!/^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(email)) {
    $('err-email').textContent = 'Enter a valid email address.';
    $('f-email').focus();
    return;
  }

  const btn = $('modal-save-btn');
  btn.disabled = true;
  btn.textContent = 'Savingâ€¦';

  try {
    const res = await fetch(API, {
      method: 'POST',
      headers: { 'Content-Type': 'application/json', 'x-metrics-key': KEY },
      body: JSON.stringify({ email, name, businessName: business, notes }),
    });
    const data = await res.json();
    if (!res.ok) throw new Error(data.error || 'Save failed');

    $('modal-backdrop').classList.remove('open');
    toast(editEmail ? 'Customer updated.' : 'Customer added.');
    await load();

    if (editEmail && $('detail-panel').classList.contains('open')) {
      openDetail(email);
    }
  } catch (e) {
    toast('Error: ' + e.message, 'error');
  } finally {
    btn.disabled = false;
    btn.textContent = editEmail ? 'Save Changes' : 'Add Customer';
  }
}

// â”€â”€ Delete â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

async function confirmDelete(email) {
  const c = allCustomers.find(x => x.email === email);
  const label = c?.name ? `${c.name} (${email})` : email;
  if (!confirm(`Delete customer ${label}?\n\nThis cannot be undone.`)) return;
  await deleteCustomer(email);
}

async function deleteCustomer(email) {
  try {
    const res = await fetch(`${API}?email=${encodeURIComponent(email)}`, {
      method: 'DELETE',
      headers: { 'x-metrics-key': KEY },
    });
    const data = await res.json();
    if (!res.ok) throw new Error(data.error || 'Delete failed');
    toast('Customer deleted.');
    closeDetail();
    await load();
  } catch (e) {
    toast('Error: ' + e.message, 'error');
  }
}

// â”€â”€ Detail Panel â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

function openDetail(email) {
  const c = allCustomers.find(x => x.email === email);
  if (!c) return;
  detailEmail = email;

  $('dp-name').textContent     = c.name || c.email;
  $('dp-email').textContent    = c.email;
  $('dp-business').textContent = c.businessName || 'â€”';
  $('dp-stripe').textContent   = c.stripeCustomerId || 'â€”';
  $('dp-count').textContent    = c.purchaseCount || 0;
  $('dp-first').textContent    = fmt(c.firstPurchaseAt);
  $('dp-last').textContent     = fmt(c.lastPurchaseAt);
  $('dp-notes').textContent    = c.notes || 'â€”';

  const prods = Array.isArray(c.products) && c.products.length
    ? c.products.map(p => fmtProduct(p)).join(', ')
    : 'â€”';
  $('dp-products').textContent = prods;

  $('detail-panel').classList.add('open');
}

function closeDetail() {
  $('detail-panel').classList.remove('open');
  detailEmail = null;
}

function editCurrentDetail() {
  if (detailEmail) openEditModal(detailEmail);
}

function deleteCurrentDetail() {
  if (detailEmail) confirmDelete(detailEmail);
}

// â”€â”€ CSV Export â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

function exportCSV() {
  const q    = ($('search').value || '').toLowerCase().trim();
  const rows = allCustomers.filter(c =>
    !q ||
    (c.email||'').toLowerCase().includes(q) ||
    (c.name||'').toLowerCase().includes(q) ||
    (c.businessName||'').toLowerCase().includes(q)
  );

  const headers = ['Name','Email','Business','Notes','Products','Purchase Count','First Purchase','Last Purchase','Stripe ID'];
  const csv = [
    headers.join(','),
    ...rows.map(c => {
      const products = Array.isArray(c.products) ? c.products.join('; ') : '';
      const col = v => `"${String(v||'').replace(/"/g,'""')}"`;
      return [
        col(c.name), col(c.email), col(c.businessName), col(c.notes),
        col(products), c.purchaseCount || 0,
        fmt(c.firstPurchaseAt), fmt(c.lastPurchaseAt), col(c.stripeCustomerId),
      ].join(',');
    }),
  ].join('\n');

  const a    = document.createElement('a');
  a.href     = URL.createObjectURL(new Blob([csv], { type: 'text/csv' }));
  a.download = `ai-operator-customers-${new Date().toISOString().slice(0,10)}.csv`;
  a.click();
  URL.revokeObjectURL(a.href);
}

// â”€â”€ Keyboard shortcuts â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

document.addEventListener('keydown', e => {
  if (e.key === 'Escape') {
    if ($('modal-backdrop').classList.contains('open')) closeModal();
    else closeDetail();
  }
});

// â”€â”€ Boot â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
load();
setInterval(load, 120000);
</script>
</body>
</html>
